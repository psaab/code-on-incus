name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.1.0)'
        required: true

permissions:
  contents: write

jobs:
  build:
    name: Build binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: '1.24'

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Build binary
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
        run: |
          make build
          mv coi coi-${{ matrix.os }}-${{ matrix.arch }}

      - name: Upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: coi-${{ matrix.os }}-${{ matrix.arch }}
          path: coi-${{ matrix.os }}-${{ matrix.arch }}

  release:
    name: Create release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download all artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          path: dist

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Prepare release files
        run: |
          mkdir -p release
          find dist -type f -name 'coi-*' -exec mv {} release/ \;
          chmod +x release/*
          ls -lh release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum coi-* > checksums.txt
          cat checksums.txt

      - name: Create release notes
        run: |
          cat > release-notes.md << 'EOF'
          ## Installation

          ### Quick Install (Linux)
          ```bash
          # Install latest version
          curl -fsSL https://raw.githubusercontent.com/mensfeld/claude-on-incus/master/install.sh | bash
          ```

          ### Manual Installation

          Download the appropriate binary for your system:

          #### Linux AMD64 (x86_64)
          ```bash
          wget https://github.com/mensfeld/claude-on-incus/releases/download/${{ steps.version.outputs.version }}/coi-linux-amd64
          chmod +x coi-linux-amd64
          sudo mv coi-linux-amd64 /usr/local/bin/coi
          ```

          #### Linux ARM64 (aarch64)
          ```bash
          wget https://github.com/mensfeld/claude-on-incus/releases/download/${{ steps.version.outputs.version }}/coi-linux-arm64
          chmod +x coi-linux-arm64
          sudo mv coi-linux-arm64 /usr/local/bin/coi
          ```

          ### Verify Installation
          ```bash
          coi version
          coi build sandbox
          coi shell
          ```

          ## What's Changed

          See [CHANGELOG.md](https://github.com/mensfeld/claude-on-incus/blob/master/CHANGELOG.md) for full changes.

          ## Requirements

          - **Incus** - Linux container manager
          - **Go 1.21+** - For building from source
          - **incus-admin group** - User must be in incus-admin group

          ## Documentation

          - [README](https://github.com/mensfeld/claude-on-incus/blob/master/README.md)
          - [PERSISTENT_MODE.md](https://github.com/mensfeld/claude-on-incus/blob/master/PERSISTENT_MODE.md)
          - [Integration Tests](https://github.com/mensfeld/claude-on-incus/blob/master/INTE.md)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release-notes.md
          files: |
            release/coi-*
            release/checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -f latest
          git push -f origin latest
